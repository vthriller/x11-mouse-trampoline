#!/usr/bin/env python
import PIL.ImageGrab
import PIL.ImageTk
from tkinter import Tk, Frame, Canvas, NW
import Xlib
import Xlib.display

# TODO: is there a way to reuse X handle from Tk, or to supply our own? (Same for ImageGrab.)
display = Xlib.display.Display()
root = display.screen().root

pos = root.query_pointer()
pos = (pos.root_x, pos.root_y)
# shift window so that real cursor ends up over its position on a screenshot
pos = (pos[0]-pos[0]//4, pos[1]-pos[1]//4)

img = PIL.ImageGrab.grab().reduce(4)

window = Tk()
window.geometry(f'{pos[0]:+}{pos[1]:+}')
window.title('mouse trampoline (left click to jump, right click to cancel)')
window.resizable(False, False)

def jump(ev):
	root.warp_pointer(ev.x*4, ev.y*4)
	display.sync()

	window.quit()

tkimg = PIL.ImageTk.PhotoImage(img)

frame = Frame()
frame.pack()

canvas = Canvas(frame,
	width = img.size[0],
	height = img.size[1],
)
canvas.create_image(0, 0, anchor=NW, image=tkimg)
canvas.bind('<Button-1>', jump)
canvas.bind('<Button-3>', lambda ev: window.quit())
canvas.pack()

window.mainloop()
